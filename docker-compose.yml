services:
  cloudterm:
    build: .
    container_name: cloudterm-app
    ports:
      - "5000:5000"
    volumes:
      - ~/.aws:/home/cloudterm/.aws:ro
      - instance-cache:/app/cache
    environment:
      - PORT=5000
      - TAG1=${TAG1:-Customer}
      - TAG2=${TAG2:-Environment}
      - RDP_MODE=guacamole
      - GUAC_WS_URL=ws://localhost:8080
      - GUAC_CRYPT_SECRET=${GUAC_CRYPT_SECRET:-cloudterm-guac-secret-key-32byte}
      - SSM_FORWARDER_HOST=ssm-forwarder
      - SSM_FORWARDER_PORT=5001
      - INSTANCES_FILE=/app/cache/instances_list.yaml
    depends_on:
      guacd:
        condition: service_started
      guac-lite:
        condition: service_healthy
      ssm-forwarder:
        condition: service_healthy
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.5'
    networks:
      - cloudterm-network
    restart: unless-stopped

  guacd:
    image: guacamole/guacd:latest
    container_name: guacd
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '1.0'
    networks:
      - cloudterm-network
    restart: unless-stopped

  guac-lite:
    build: ./docker/guac-lite
    container_name: guac-lite
    ports:
      - "8080:8080"
    environment:
      - WEBSOCKET_PORT=8080
      - GUACD_HOST=guacd
      - GUACD_PORT=4822
      - CRYPT_SECRET=${GUAC_CRYPT_SECRET:-cloudterm-guac-secret-key-32byte}
    depends_on:
      - guacd
    healthcheck:
      test: ["CMD", "node", "-e", "const http=require('http');const r=http.request({port:8080},s=>{process.exit(s.statusCode===426?0:1)});r.on('error',()=>process.exit(1));r.end()"]
      interval: 10s
      timeout: 5s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.25'
    networks:
      - cloudterm-network
    restart: unless-stopped

  ssm-forwarder:
    build:
      context: .
      dockerfile: Dockerfile.forwarder
    container_name: ssm-forwarder
    expose:
      - "5001"
    volumes:
      - ~/.aws:/home/cloudterm/.aws:ro
    environment:
      - PORT=5001
      - PORT_RANGE_START=33890
      - PORT_RANGE_END=33999
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:5001/health"]
      interval: 15s
      timeout: 5s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
    networks:
      - cloudterm-network
    restart: unless-stopped

volumes:
  instance-cache:

networks:
  cloudterm-network:
    driver: bridge
